{% load static %} 
{% load pagination_tags %}
<!DOCTYPE html>
<html>
<head><title>Books</title>
<!-- FontAwesome読み込み -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- カスタムCSS -->
  <link rel="stylesheet" href="{% static './css/external_link_window.css' %}">
</head>
  
</head>
<body>
<h1><a href="{% url 'home' %}">滋賀県立図書館 お役立ち非公式アプリ</a></h1>
<span><p>ようこそ、現在ログイン中です</p></span>
<h3>
<form method="get" action="{% url 'search' %}">
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <select name="source">
            <option value="google" {% if source == 'google' or not source %}selected{% endif %}>Googleを使って検索</option>
            <option value="rakuten" {% if source == 'rakuten' %}selected{% endif %}>楽天を使って検索</option>
        </select>
        <input type="text" name="query" placeholder="例）琵琶湖の歴史" value="{{ query }}">
        <button type="submit">検索</button>
    </div>
</form>
</h3>
<h3><a href="{% url 'display_scan_page' %}">バーコードを読み取って追加</a></h3>
<h2>あなたの本のリスト</h2>

<div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <!-- ステータス絞り込み -->
        <form method="get" action="{% url 'home' %}" style="display: inline;">
            <select name="status" onchange="this.form.submit()">
                <option value="all" {% if current_status == 'all' %}selected{% endif %}>すべてのステータス</option>
                <option value="want" {% if current_status == 'want' %}selected{% endif %}>読みたい</option>
                <option value="reading" {% if current_status == 'reading' %}selected{% endif %}>読んでいる</option>
                <option value="read" {% if current_status == 'read' %}selected{% endif %}>読んだ</option>
            </select>
            <!-- 現在のページと並び順を保持 -->
            <input type="hidden" name="page" value="{{ page_obj.number }}">
            <input type="hidden" name="sort" value="{{ sort }}">
        </form>

        <!-- 並び順スイッチ -->
        <form method="get" action="{% url 'home' %}" style="display: inline;">
            <select name="sort" onchange="this.form.submit()">
                <option value="newest" {% if sort == 'newest' %}selected{% endif %}>新しい順</option>
                <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>古い順</option>
            </select>
            <!-- 現在のページとステータスを保持 -->
            <input type="hidden" name="page" value="{{ page_obj.number }}">
            <input type="hidden" name="status" value="{{ current_status }}">
        </form>
    </div>

<!-- ページネーションUI -->
<div class="pagination">
    <p>ページ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}（全{{ page_obj.paginator.count }}件）</p>
    
    {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&status={{ current_status }}&sort={{ sort }}">前のページ</a>
    {% endif %}
    
    {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
            <span>[{{ num }}]</span>
        {% else %}
            <a href="?page={{ num }}&status={{ current_status }}&sort={{ sort }}">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&status={{ current_status }}&sort={{ sort }}">次のページ</a>
    {% endif %}

    <form method="get" action="{% url 'home' %}" style="display: inline;">
        <input type="number" name="page" min="1" max="{{ page_obj.paginator.num_pages }}" placeholder="ページ番号">
        <input type="hidden" name="status" value="{{ current_status }}">
        <input type="hidden" name="sort" value="{{ sort }}">
        <button type="submit">移動</button>
    </form>
</div>

{% if page_obj %}
    <ul>
    {% for book in page_obj %}
    <li data-isbn="{{ book.isbn_id }}">
        {{ book.title }} - {{ book.author }}
        (ISBN:{{ book.isbn_id}})
        <br>
        {% if book.image_link %}
            <img src="{{ book.image_link }}" alt="{{ book.title }}の画像" style="max-width: 100px;">
        {% else %}
            <img src="{% static '/images/no_image.png' %}" alt="画像なし" style="max-width: 100px;">
        {% endif %}
        <br>
        <span class="status-text" style="color: green;">
            {% if book.is_read %}✓読んだ
            {% elif book.is_reading %}✓読んでいる
            {% elif book.is_want_to_read %}✓読みたい
            {% else %}未設定{% endif %}
        </span>
        
            <a href="{{ book.calil_link }}" 
               target="_blank" 
               rel="noopener noreferrer" 
               class="external-link">
               滋賀県立図書館の蔵書を確認
               <i class="fas fa-external-link-alt"></i>
            </a>
        <form class="book-form" method="post" action="{% url 'update_book_status' book.isbn_id %}">
            {% csrf_token %}
            <label><input type="radio" name="status" value="want" {% if book.is_want_to_read %}checked{% endif %}>読みたい</label>
            <label><input type="radio" name="status" value="reading" {% if book.is_reading %}checked{% endif %}>読んでいる</label>
            <label><input type="radio" name="status" value="read" {% if book.is_read %}checked{% endif %}>読んだ</label>
            <button type="submit" class="update-btn">変更</button>
            <button type="button" class="delete-btn" data-isbn="{{ book.isbn_id }}">削除</button>
        </form>
        {% empty %}
            <li>本がありません。検索して追加してください。</li>
        {% endfor %}
    </ul>
    <!-- ページネーションUI -->
    <div class="pagination">
        <p>ページ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}（全{{ page_obj.paginator.count }}件）</p>
        
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&status={{ current_status }}&sort={{ sort }}">前のページ</a>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
                <span>[{{ num }}]</span>
            {% else %}
                <a href="?page={{ num }}&status={{ current_status }}&sort={{ sort }}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&status={{ current_status }}&sort={{ sort }}">次のページ</a>
        {% endif %}

        <!-- <form method="get" action="{% url 'home' %}" style="display: inline;">
            <input type="number" name="page" min="1" max="{{ page_obj.paginator.num_pages }}" placeholder="ページ番号">
            <input type="hidden" name="status" value="{{ current_status }}">
            <input type="hidden" name="sort" value="{{ sort }}">
            <button type="submit">移動</button>
        </form> -->
    </div>
    {% else %}
    <p>本がありません。検索して追加してください。</p>
{% endif %}

<script>
    let deletedBooks = {};
    
    function updateStatusText(li, status) {
        const statusText = li.querySelector('.status-text') || li.appendChild(document.createElement('span'));
        statusText.className = 'status-text';
        statusText.style.color = 'green';
        statusText.textContent = status ? `${status === 'want' ? '読みたい' : status === 'reading' ? '読んでいる' : '読んだ'}` : '未設定';
    }
    
    document.querySelectorAll('.book-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const li = this.closest('li');
            const isbn = li.dataset.isbn;
            fetch(this.action, {
                method: 'POST',
                body: new FormData(this),
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'updated') {
                    updateStatusText(li, data.current_status);
                }
            })
            .catch(error => console.error('更新エラー:', error));
        });
    });
    
    function attachDeleteEvent(btn) {
        btn.addEventListener('click', function() {
            const isbn = this.dataset.isbn;
            const li = btn.closest('li');
            const form = li.querySelector('form');
            const bookData = {
                title: li.textContent.split(' - ')[0].trim(),
                author: li.textContent.split(' - ')[1].split(' [')[0].trim(),
                status: form.querySelector('input[name=status]:checked')?.value || 'want'
            };
            fetch(`/delete/${isbn}/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'deleted') {
                    deletedBooks[isbn] = bookData;
                    const statusText = li.querySelector('.status-text');
                    statusText.style.color = 'red';
                    statusText.textContent = '[削除済み]';
                    btn.remove();
                    form.innerHTML = `
                        {% csrf_token %}
                        <button type="button" class="undo-btn" data-isbn="${isbn}">削除を取り消す</button>
                    `;
                    attachUndoEvent(li.querySelector('.undo-btn'));
                }
            })
            .catch(error => console.error('削除エラー:', error));
        });
    }
    
    function attachUndoEvent(btn) {
        btn.addEventListener('click', function() {
            const isbn = this.dataset.isbn;
            const li = btn.closest('li');
            const form = li.querySelector('form');
            const undoData = deletedBooks[isbn];
            if (!undoData) {
                console.error('削除データが見つかりません:', isbn);
                return;
            }
            const formData = new FormData();
            formData.append('title', undoData.title);
            formData.append('author', undoData.author);
            formData.append('isbn_id', isbn);
            formData.append('status', undoData.status);
            fetch(`/add/`, {
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'added') {
                    updateStatusText(li, undoData.status);
                    form.action = `/update/${isbn}/`;
                    form.innerHTML = `
                        {% csrf_token %}
                        <label><input type="radio" name="status" value="want" ${undoData.status === 'want' ? 'checked' : ''}>読みたい</label>
                        <label><input type="radio" name="status" value="reading" ${undoData.status === 'reading' ? 'checked' : ''}>読んでいる</label>
                        <label><input type="radio" name="status" value="read" ${undoData.status === 'read' ? 'checked' : ''}>読んだ</label>
                        <button type="submit" class="update-btn">変更</button>
                        <button type="button" class="delete-btn" data-isbn="${isbn}">削除</button>
                    `;
                    delete deletedBooks[isbn];
                    attachDeleteEvent(li.querySelector('.delete-btn'));
                } else {
                    console.error('追加失敗:', data);
                }
            })
            .catch(error => console.error('取り消しエラー:', error));
        });
    }
    
    document.querySelectorAll('.delete-btn').forEach(attachDeleteEvent);

    </script>
</body>
</html>
